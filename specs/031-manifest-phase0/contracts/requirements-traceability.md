# Requirements Traceability Matrix — Manifest Task System Phase 0

**Feature**: `031-manifest-phase0`  
**Source**: `docs/ManifestTaskSystem.md`

| DOC-REQ ID | Mapped FR(s) | Implementation Touchpoints | Validation Strategy |
|------------|--------------|-----------------------------|---------------------|
| `DOC-REQ-001` — Register `manifest` job type; isolate from codex/gemini (§6.1) | `FR-001`, `FR-002`, `FR-012` | `moonmind/workflows/agent_queue/job_types.py` (canonical constants); `service.py::create_job` (type routing); `repositories.py::_is_job_claim_eligible` (capability filtering); `moonmind/schemas/agent_queue_models.JobModel` (sanitized payload + `type=manifest`); `api_service/api/routers/agent_queue.py` filters | Unit tests in `tests/unit/workflows/agent_queue/test_repositories.py` and `tests/unit/api/routers/test_agent_queue.py` ensure manifest jobs require the full capability set and listings expose only sanitized metadata. |
| `DOC-REQ-002` — Dedicated manifest contract for YAML validation (§6.2) | `FR-003`, `FR-004`, `FR-006` | `moonmind/workflows/agent_queue/manifest_contract.py` (normalization, name match, option allowlist); `AgentQueueService.create_job` caller; `api_service/services/manifests_service.py` reuses the contract for registry flows | `tests/unit/workflows/agent_queue/test_manifest_contract.py` exercises happy path + error cases (name mismatch, unsupported adapters/options); router/service tests confirm 422 errors surface through `/api/manifests`. |
| `DOC-REQ-003` — Derive and persist `requiredCapabilities`, hashes, versions (§6.5–§6.6) | `FR-005`, `FR-010` | `derive_required_capabilities()`, `_compute_manifest_hash()`, payload persistence within `AgentQueueService`; manifest registry service storing `content_hash`/`version`; API serializers exposing derived metadata | Contract tests assert capability lists match manifest content; router/service tests verify responses include `manifestHash`/`requiredCapabilities`; `tests/unit/workflows/agent_queue/test_service_manifest.py` covers queue persistence. |
| `DOC-REQ-004` — Token-free payloads; reject raw secrets (§11.1) | `FR-007` | `manifest_contract.detect_manifest_secret_leaks()` invoked during normalization; error propagation through queue + registry endpoints | Unit tests craft manifests containing `sk-` / `ghp_` / `token=` values and assert `ManifestContractError`; `/api/manifests` + `/api/queue/jobs` tests verify HTTP 422 when raw secrets are supplied. |
| `DOC-REQ-005` — Manifest registry CRUD + runs + checkpoint columns (§7) | `FR-008`, `FR-009`, `FR-010`, `FR-011` | `api_service/api/routers/manifests.py`; `api_service/services/manifests_service.py`; `api_service/db/models.ManifestRecord`; Alembic migrations `202602190003` + `202602190004`; queue integration linking run metadata back to registry rows | Router/service unit tests validate GET/PUT/POST flows, metadata persistence, checkpoint columns, and job ID linkage; quickstart instructions plus `./tools/test_unit.sh` provide runtime verification. |
| `DOC-REQ-006` — Enforce supported manifest source kinds (`inline`, `registry`, guarded `path`) (§6.3) | `FR-014` | `moonmind/workflows/agent_queue/manifest_contract.py` validates `manifest.source.kind`; `api_service/api/routers/agent_queue.py` + `/api/manifests/*/runs` propagate errors; sanitizers in `moonmind/schemas/agent_queue_models.py` redact invalid submissions | `tests/unit/workflows/agent_queue/test_manifest_contract.py` asserts allowed kinds pass and other kinds fail; router/service tests confirm HTTP 422 with actionable messages. |
| `DOC-REQ-007` — Restrict manifest actions to `plan`/`run` in Phase 0 (§6.4) | `FR-015` | `manifest_contract.py` action gating + error strings; `AgentQueueService.create_job` + manifests service enforce gate before persistence; queue serializers surface action metadata | Contract + router tests submit `evaluate`/unknown actions and assert `ManifestContractError`; happy-path tests prove `plan`/`run` payloads flow end-to-end. |
| `DOC-REQ-008` — Emit manifest secret reference metadata (§6.6) | `FR-016` | `moonmind/workflows/agent_queue/manifest_contract.py::_collect_secret_refs` populates `payload.manifestSecretRefs`; `moonmind/schemas/agent_queue_models.JobModel` preserves sanitized references in API responses; `api_service/services/manifests_service.py` + `/api/queue/jobs` reuse the contract so queue persistence stays token-free | Unit tests in `tests/unit/workflows/agent_queue/test_manifest_contract.py` assert profile/vault reference capture + sanitization, and queue/router tests verify secret-leak detection raises HTTP 422, preventing raw-secret regressions. |
