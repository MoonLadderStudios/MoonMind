# Requirements Traceability Matrix: Worker Pause System

**Feature**: `035-worker-pause`  
**Source**: `docs/WorkerPauseSystem.md`

| DOC-REQ ID | Mapped FR(s) | Planned Implementation Surface | Validation Strategy |
|------------|--------------|--------------------------------|--------------------|
| `DOC-REQ-001`<br/>Single operator control for Pause → Drain → Upgrade → Resume | `FR-002`, `FR-012` | FastAPI router `api_service/api/routers/system_worker_pause.py` (POST handler with reason/mode validation) + service-layer toggle helpers emitting structured logs/metrics | API unit tests covering POST happy paths + invalid transitions; service tests asserting reason required; log/metric assertions via fakes |
| `DOC-REQ-002`<br/>Persist global pause state | `FR-001` | New SQLAlchemy model + Alembic migration (`system_worker_pause_state`) and repository helpers (`AgentQueueRepository.ensure_pause_state`, `update_pause_state`) | Migration smoke test via sqlite fixtures; repository tests verifying defaults, row seeding, and `version` increments under concurrent updates |
| `DOC-REQ-003`<br/>Audit every pause/resume | `FR-007` | `SystemControlEvent` model + append helper; GET response includes `audit.latest`; dashboard surfaces event summaries | Repository tests ensure each toggle writes an event; API tests assert `audit.latest[0]` matches the last action |
| `DOC-REQ-004`<br/>Guard claim path to avoid queue mutation | `FR-004` | `AgentQueueService.claim_job` guard + dataclass result; router adapts responses; repository `_requeue_expired_jobs` untouched while paused | Service tests mocking repository to prove `_requeue_expired_jobs` not called when paused; router tests ensuring HTTP 200 with `{job:null, system:{...}}` |
| `DOC-REQ-005`<br/>Extend claim/heartbeat payloads with pause metadata | `FR-005`, `FR-006`, `FR-011` | Shared `QueueSystemMetadataModel`, router serialization updates, worker queue client parsing, MCP tool registry pass-through | API + MCP tests verifying `system` block propagation; worker unit tests confirming log-once-per-version + pause backoff behavior |
| `DOC-REQ-006`<br/>Operator GET/POST endpoints with metrics | `FR-002`, `FR-003`, `FR-009` | New router + schema models; repository metrics helper; dashboard fetcher (config + JS) | API tests covering GET metrics, stale-running counts, and validation errors; dashboard view-model tests ensuring endpoints are emitted |
| `DOC-REQ-007`<br/>Worker runtime behavior for drain/quiesce | `FR-005`, `FR-006`, `FR-010`, `FR-012` | `moonmind/agents/codex_worker/worker.py` (pause events, quiesce checkpoint gating, `pause_poll_interval_ms`) + heartbeat loop changes | Worker-focused unit tests (or integration fakes) verifying pause/resume logging, heartbeat quiesce toggles, and checkpoint waits; manual quickstart step |
| `DOC-REQ-008`<br/>Dashboard banner + controls | `FR-008` | `api_service/templates/task_dashboard.html`, `static/task_dashboard/dashboard.{js,css}` banner/control components | Node-based smoke tests for dashboard bootstrap + new DOM elements; manual dashboard verification per quickstart |
| `DOC-REQ-009`<br/>Drain vs Quiesce mode guidance | `FR-002`, `FR-006`, `FR-008`, `FR-010` | API validation to enforce mode rules, dashboard copy+warnings, quickstart scenario describing each mode | API tests covering conflicting pause requests + quiesce/resume flows; dashboard JS tests asserting warning banner when resuming before drain |
| `DOC-REQ-010`<br/>Expose queued/running/stale counts while paused | `FR-003`, `FR-009`, `FR-012` | Repository metrics queries surfaced via GET + dashboard drain card + quickstart instructions | Repository tests verifying COUNT logic; API tests asserting `metrics.isDrained`; dashboard JS tests ensuring values render + refresh |
