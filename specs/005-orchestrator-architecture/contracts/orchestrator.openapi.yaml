openapi: 3.0.3
info:
  title: MoonMind Orchestrator API
  version: 0.1.0
  description: >
    Contracts that allow MoonMind operators and services to submit repair instructions,
    monitor orchestrator runs, provide approvals, and fetch artifacts generated by the
    mm-orchestrator service.
tags:
  - name: orchestrator-runs
    description: Submit and manage orchestrator instructions
paths:
  /orchestrator/runs:
    post:
      tags: [orchestrator-runs]
      summary: Submit a new orchestrator instruction
      description: Creates an orchestrator run that generates an ActionPlan and begins queued execution.
      operationId: createRun
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRunRequest'
      responses:
        '202':
          description: Run accepted and queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunSummary'
        '400':
          description: Validation failure (unknown service, missing approval)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      tags: [orchestrator-runs]
      summary: List orchestrator runs
      description: Returns the most recent runs with optional filtering by status or service.
      operationId: listRuns
      parameters:
        - in: query
          name: status
          schema:
            $ref: '#/components/schemas/RunStatus'
          description: Filter by current run status.
        - in: query
          name: service
          schema:
            type: string
          description: Filter by target service name.
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: List of orchestrator runs
          content:
            application/json:
              schema:
                type: object
                properties:
                  runs:
                    type: array
                    items:
                      $ref: '#/components/schemas/RunSummary'
  /orchestrator/runs/{run_id}:
    get:
      tags: [orchestrator-runs]
      summary: Fetch run details
      description: Retrieves full state, plan steps, and artifacts for a specific run.
      operationId: getRun
      parameters:
        - $ref: '#/components/parameters/RunId'
      responses:
        '200':
          description: Run details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunDetail'
        '404':
          description: Run not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /orchestrator/runs/{run_id}/artifacts:
    get:
      tags: [orchestrator-runs]
      summary: List artifacts associated with a run
      operationId: listArtifacts
      parameters:
        - $ref: '#/components/parameters/RunId'
      responses:
        '200':
          description: Artifact references
          content:
            application/json:
              schema:
                type: object
                properties:
                  artifacts:
                    type: array
                    items:
                      $ref: '#/components/schemas/RunArtifact'
  /orchestrator/runs/{run_id}/approvals:
    post:
      tags: [orchestrator-runs]
      summary: Provide approval for a protected service run
      description: Records approval details and unblocks pending runs that require authorization.
      operationId: provideApproval
      parameters:
        - $ref: '#/components/parameters/RunId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApprovalRequest'
      responses:
        '200':
          description: Approval recorded; run resumes if still pending
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunSummary'
        '409':
          description: Approval invalid or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /orchestrator/runs/{run_id}/retry:
    post:
      tags: [orchestrator-runs]
      summary: Retry or resume a failed orchestrator run
      description: Replays from the failing plan step when safe, otherwise queues a fresh run that reuses stored artifacts.
      operationId: retryRun
      parameters:
        - $ref: '#/components/parameters/RunId'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RetryRequest'
      responses:
        '202':
          description: Retry accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunSummary'
        '409':
          description: Run cannot be retried (e.g., still running)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  parameters:
    RunId:
      name: run_id
      in: path
      required: true
      schema:
        type: string
        format: uuid
  schemas:
    CreateRunRequest:
      type: object
      required:
        - instruction
        - target_service
      properties:
        instruction:
          type: string
          description: High-level operator request (e.g., "fix missing dependency for api").
        target_service:
          type: string
          description: docker-compose service name.
        approval_token:
          type: string
          description: Optional token satisfying ApprovalGate requirements.
        priority:
          type: string
          enum: [normal, high]
          default: normal
    RunSummary:
      type: object
      required:
        - run_id
        - status
        - target_service
      properties:
        run_id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/RunStatus'
        target_service:
          type: string
        instruction:
          type: string
        queued_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true
        approval_required:
          type: boolean
        approval_status:
          type: string
          enum: [not_required, awaiting, granted, expired]
          default: not_required
    RunDetail:
      allOf:
        - $ref: '#/components/schemas/RunSummary'
        - type: object
          properties:
            action_plan:
              $ref: '#/components/schemas/ActionPlan'
            steps:
              type: array
              items:
                $ref: '#/components/schemas/PlanStepState'
            artifacts:
              type: array
              items:
                $ref: '#/components/schemas/RunArtifact'
    ActionPlan:
      type: object
      required:
        - plan_id
        - steps
      properties:
        plan_id:
          type: string
          format: uuid
        generated_at:
          type: string
          format: date-time
        generated_by:
          type: string
          enum: [operator, system, llm]
        steps:
          type: array
          items:
            $ref: '#/components/schemas/PlanStepDefinition'
    PlanStepDefinition:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          enum: [analyze, patch, build, restart, verify, rollback]
        parameters:
          type: object
          additionalProperties: true
    PlanStepState:
      type: object
      required:
        - name
        - status
      properties:
        name:
          type: string
          enum: [analyze, patch, build, restart, verify, rollback]
        status:
          type: string
          enum: [pending, in_progress, succeeded, failed, skipped]
        started_at:
          type: string
          format: date-time
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true
        celery_task_id:
          type: string
        message:
          type: string
        artifact_refs:
          type: array
          items:
            type: string
            format: uuid
    RunArtifact:
      type: object
      required:
        - artifact_id
        - type
        - path
      properties:
        artifact_id:
          type: string
          format: uuid
        type:
          type: string
          enum: [patch_diff, build_log, verify_log, rollback_log, metrics, plan_snapshot]
        path:
          type: string
          description: Relative path under `var/artifacts/spec_workflows/<run_id>`.
        checksum:
          type: string
        size_bytes:
          type: integer
        created_at:
          type: string
          format: date-time
    ApprovalRequest:
      type: object
      required:
        - approver
        - token
      properties:
        approver:
          type: object
          required: [id, role]
          properties:
            id:
              type: string
            role:
              type: string
        token:
          type: string
        expires_at:
          type: string
          format: date-time
    RetryRequest:
      type: object
      properties:
        resume_from_step:
          type: string
          enum: [patch, build, restart, verify, rollback]
          description: Explicit step to restart from; defaults to failing step when omitted.
        reason:
          type: string
    RunStatus:
      type: string
      enum: [pending, running, awaiting_approval, succeeded, failed, rolled_back]
    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
        detail:
          type: string
        remediation:
          type: string
