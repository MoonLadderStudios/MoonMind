openapi: 3.1.0
info:
  title: MoonMind Spec Workflow API
  version: 0.1.0
  description: |
    Contracts for triggering, monitoring, and retrying Spec Kit Celery chains.
servers:
  - url: https://api.moonmind.local
paths:
  /api/workflows/speckit/runs:
    post:
      summary: Trigger the next Spec Kit phase via the Celery chain.
      operationId: createSpecWorkflowRun
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorkflowRunRequest'
      responses:
        '202':
          description: Run accepted and Celery chain enqueued.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpecWorkflowRun'
        '409':
          description: Run already in progress for the same feature key.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      summary: List workflow runs with optional status filtering.
      operationId: listSpecWorkflowRuns
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [pending, running, succeeded, failed, no_work, retrying]
          description: Optional lifecycle filter.
        - in: query
          name: cursor
          schema:
            type: string
          description: Opaque pagination cursor from the previous page.
      responses:
        '200':
          description: Paginated run collection.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowRunCollection'
  /api/workflows/speckit/runs/{runId}:
    get:
      summary: Retrieve a workflow run with task states and artifacts.
      operationId: getSpecWorkflowRun
      parameters:
        - $ref: '#/components/parameters/RunId'
        - in: query
          name: includeTasks
          schema:
            type: boolean
            default: true
        - in: query
          name: includeArtifacts
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Run found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpecWorkflowRun'
        '404':
          description: Run not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/workflows/speckit/runs/{runId}/tasks:
    get:
      summary: Return task-level telemetry for the run.
      operationId: listSpecWorkflowRunTasks
      parameters:
        - $ref: '#/components/parameters/RunId'
      responses:
        '200':
          description: Ordered task states.
          content:
            application/json:
              schema:
                type: object
                properties:
                  runId:
                    type: string
                    format: uuid
                  tasks:
                    type: array
                    items:
                      $ref: '#/components/schemas/WorkflowTaskState'
        '404':
          description: Run not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/workflows/speckit/runs/{runId}/retry:
    post:
      summary: Retry or resume a failed Celery chain from the failing task.
      operationId: retrySpecWorkflowRun
      parameters:
        - $ref: '#/components/parameters/RunId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RetryWorkflowRunRequest'
      responses:
        '202':
          description: Retry accepted; new Celery chain enqueued.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpecWorkflowRun'
        '409':
          description: Run not eligible for retry or credentials missing.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/workflows/speckit/runs/{runId}/artifacts:
    get:
      summary: List artifact metadata for download links.
      operationId: listSpecWorkflowArtifacts
      parameters:
        - $ref: '#/components/parameters/RunId'
      responses:
        '200':
          description: Artifact listing returned.
          content:
            application/json:
              schema:
                type: object
                properties:
                  runId:
                    type: string
                    format: uuid
                  artifacts:
                    type: array
                    items:
                      $ref: '#/components/schemas/WorkflowArtifact'
        '404':
          description: Run not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  parameters:
    RunId:
      name: runId
      in: path
      required: true
      schema:
        type: string
        format: uuid
  schemas:
    CreateWorkflowRunRequest:
      type: object
      required: [repository]
      properties:
        repository:
          type: string
          pattern: '^[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+$'
        featureKey:
          type: string
          maxLength: 120
        forcePhase:
          type: string
          enum: [discover, submit, apply, publish]
        notes:
          type: string
          maxLength: 1024
    RetryWorkflowRunRequest:
      type: object
      properties:
        mode:
          type: string
          enum: [resume_failed_task, restart_from_discovery]
          default: resume_failed_task
        notes:
          type: string
          maxLength: 1024
    WorkflowRunCollection:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/SpecWorkflowRun'
        nextCursor:
          type: string
          nullable: true
    SpecWorkflowRun:
      type: object
      properties:
        id:
          type: string
          format: uuid
        featureKey:
          type: string
        status:
          type: string
          enum: [pending, running, succeeded, failed, cancelled]
        phase:
          type: string
          enum: [discover, submit, apply, publish, complete]
        branchName:
          type: string
          nullable: true
        prUrl:
          type: string
          format: uri
          nullable: true
        codexTaskId:
          type: string
          nullable: true
        codexQueue:
          type: string
          nullable: true
        codexVolume:
          type: string
          nullable: true
        codexPreflightStatus:
          type: string
          enum: [passed, failed, skipped]
          nullable: true
        codexPreflightMessage:
          type: string
          nullable: true
        codexLogsPath:
          type: string
          nullable: true
        codexPatchPath:
          type: string
          nullable: true
        celeryChainId:
          type: string
          description: Celery root task identifier for the workflow chain
          nullable: true
        createdBy:
          type: string
          format: uuid
          nullable: true
        startedAt:
          type: string
          format: date-time
          nullable: true
        finishedAt:
          type: string
          format: date-time
          nullable: true
        artifactsPath:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
          nullable: true
        updatedAt:
          type: string
          format: date-time
          nullable: true
        tasks:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowTaskState'
        taskSummary:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowTaskSummary'
        artifacts:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowArtifact'
        credentialAudit:
          $ref: '#/components/schemas/WorkflowCredentialAudit'
          nullable: true
      required: [id, featureKey, status, phase]
    WorkflowTaskState:
      type: object
      properties:
        id:
          type: string
          format: uuid
        taskName:
          type: string
        status:
          type: string
          enum: [queued, running, succeeded, failed, skipped]
        attempt:
          type: integer
          minimum: 1
        payload:
          type: object
        startedAt:
          type: string
          format: date-time
          nullable: true
        finishedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
          nullable: true
        updatedAt:
          type: string
          format: date-time
          nullable: true
      required: [taskName, status, attempt]

    WorkflowTaskSummary:
      type: object
      properties:
        taskName:
          type: string
        status:
          type: string
          enum: [queued, running, succeeded, failed, skipped]
        attempt:
          type: integer
          minimum: 1
        startedAt:
          type: string
          format: date-time
          nullable: true
        finishedAt:
          type: string
          format: date-time
          nullable: true
        updatedAt:
          type: string
          format: date-time
          nullable: true
      required: [taskName, status, attempt]
    WorkflowArtifact:
      type: object
      properties:
        id:
          type: string
          format: uuid
        artifactType:
          type: string
          enum: [codex_logs, codex_patch, gh_push_log, gh_pr_response]
        path:
          type: string
        createdAt:
          type: string
          format: date-time
          nullable: true
      required: [artifactType, path]

    WorkflowCredentialAudit:
      type: object
      properties:
        codexStatus:
          type: string
          enum: [valid, invalid, expires_soon]
        githubStatus:
          type: string
          enum: [valid, invalid, scope_missing]
        checkedAt:
          type: string
          format: date-time
          nullable: true
        notes:
          type: string
          nullable: true
    ErrorResponse:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
