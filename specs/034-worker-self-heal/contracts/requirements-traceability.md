# Requirements Traceability: Worker Self-Heal System

| Source Requirement | Spec FR Mapping | Planned Implementation Surfaces | Validation Strategy |
| --- | --- | --- | --- |
| DOC-REQ-001 – Detect step stuck states (wall, idle, no-progress) | FR-001, FR-003 | `moonmind/agents/codex_worker/self_heal.py` (watchdogs + signature tracking), `moonmind/agents/codex_worker/worker.py` integration + live-log callbacks | Unit tests in `tests/unit/agents/codex_worker/test_worker.py` covering wall-clock timeouts, idle timers, and repeated signature detection; manual smoke via quickstart idle hang scenario. |
| DOC-REQ-002 – Enforce bounded budgets with defaults | FR-002 | `moonmind/agents/codex_worker/self_heal.py` config dataclasses, `moonmind/agents/codex_worker/worker.py` (env→config wiring), `celery_worker/speckit_worker.py` env defaults | Unit tests verifying counter decrements/stop conditions plus config parsing tests; `./tools/test_unit.sh -k self_heal` ensures respecting `step_max_attempts`, `job_self_heal_max_resets`. |
| DOC-REQ-003 – Failure classification buckets | FR-003 | Failure-class heuristics inside `self_heal.py`, event payloads in `worker.py` | Unit tests injecting synthetic exceptions to assert deterministic/transient labels and queue retry flags; telemetry assertions for `task.self_heal.triggered{class=*}`. |
| DOC-REQ-004 – Soft reset retries with compact prompt | FR-004, FR-006 | `self_heal.py` strategy selection, `_compose_step_instruction_for_runtime` minimal context builder, runtime restart hooks in `worker.py` | Tests that simulate transient failures and assert runtime restart + prompt contents; quickstart soft-reset scenario. |
| DOC-REQ-005 – Hard reset + workspace rebuild | FR-005 | Checkpoint writer (`state/steps/*.json`), replay helper in `self_heal.py`, repo re-clone/reset logic inside `worker.py` | Unit tests using temp repos to ensure patches replay + resume-from-step succeed, plus integration smoke instructions in quickstart. |
| DOC-REQ-006 – Minimal retry context in prompts | FR-006 | Retry envelope builder (objective, failure summary, diff hash) inside `self_heal.py` / `_compose_step_instruction_for_runtime` | Unit tests comparing generated prompt text to expected minimal format; event snapshots to confirm context stored in artifacts. |
| DOC-REQ-007 – Persist checkpoints + resume semantics | FR-007 | Patch/artifact writer in `worker.py`, new `state/steps/*.json` structure, replay API invoked by hard reset/resume | Tests ensure files are written per step and consumed by replay logic; artifact upload tests for `FakeQueueClient`. |
| DOC-REQ-008 – Bounded attempt loop respects cancel/pause/takeover | FR-008 | Main worker loop (`worker.py`) now calls controller between attempts while still checking `_active_cancel_event`/`_active_pause_event` | Existing pause/cancel tests expanded to cover pending self-heal attempts; manual test by issuing pause via API mid-loop. |
| DOC-REQ-009 – Recovery actions in queue control APIs | FR-009 | `moonmind/workflows/agent_queue/service.py` & `repositories.py` (liveControl.recovery), `api_service/api/routers/task_runs.py` & dashboard JS for new actions, worker heartbeat consumers | API/router unit tests verifying new actions + validation; dashboard/manual verification that buttons issue correct payload; worker tests assert recovery command consumption. |
| DOC-REQ-010 – Events + artifacts contain metadata | FR-010 | Event emission helpers in `worker.py` (new `task.step.attempt.*`, `task.self_heal.*`, `task.resume.from_step`), artifact schema documented in `data-model.md` | Unit tests assert payload fields, `FakeQueueClient.events` snapshot comparisons, artifact upload tests for JSON files. |
| DOC-REQ-011 – StatsD metrics | FR-011 | `moonmind/agents/codex_worker/metrics.py` adapter (reusing `_MetricsEmitter`), metric calls inside controller | Tests monkeypatching emitter to capture metric names/tags; optional manual check via StatsD sink. |
| DOC-REQ-012 – Secret scrubbing | FR-012 | Existing `SecretRedactor` plus new wrappers around failure signature/diff hash generation in `self_heal.py` | Unit tests feeding secret-like strings and asserting scrubbed payloads; regression tests ensure artifacts don’t contain tokens. |
