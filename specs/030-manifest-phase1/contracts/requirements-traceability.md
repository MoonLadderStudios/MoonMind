# Requirements Traceability Matrix: Manifest Task System Phase 1

**Feature**: `030-manifest-phase1`  
**Source**: `docs/ManifestTaskSystem.md`

| DOC-REQ ID | Mapped FR(s) | Planned Implementation Surface | Validation Strategy |
|------------|--------------|--------------------------------|--------------------|
| `DOC-REQ-001` (manifest_v0 package + pipeline skeleton) | `FR-001` | New `moonmind/manifest_v0/*` package (models, yaml_io, validator, interpolate, secret_refs, readers/, transforms/, embeddings_factory.py, vector_store_factory.py, id_policy.py, state_store.py, engine.py, reports.py) wired into manifest worker runtime | Unit tests under `tests/unit/manifest_v0/test_engine.py` cover plan/run orchestration, deterministic pipelines, and module import coverage executed via `./tools/test_unit.sh` |
| `DOC-REQ-002` (ReaderAdapter protocol + dataclasses) | `FR-002` | `moonmind/manifest_v0/readers/base.py` + adapter subclasses; dataclasses exported for reuse by engine + tests | Adapter contract tests (`tests/unit/manifest_v0/readers/test_base.py`, adapter-specific suites) verify emitted `SourceChange` events, checkpoint snapshots, and error handling |
| `DOC-REQ-003` (baseline adapters + capability tokens) | `FR-003` | `moonmind/manifest_v0/readers/github.py`, `google_drive.py`, `confluence.py`, `simple_directory.py`; capability mappings reused by `manifest_contract.derive_required_capabilities` and worker capability filtering | Fixtures-driven unit tests that simulate API responses/filesystems to prove adapters emit deterministic doc hashes, delete signals, and capability labels; manifest worker integration tests ensure jobs requiring these capabilities are claimable only when worker advertises them |
| `DOC-REQ-004` (deterministic transforms + chunking) | `FR-004` | `moonmind/manifest_v0/transforms/html.py`, `splitter.py`, `metadata.py`, plus utilities referenced by `engine.py` | Unit tests verifying HTML stripping, chunk boundaries, metadata enrichment, and hash stability; golden-file tests assert unchanged docs skip embeddings |
| `DOC-REQ-005` (embeddings factory honoring manifest config) | `FR-005` | `moonmind/manifest_v0/embeddings_factory.py` + provider adapters; progress callbacks consumed by worker stage events | Mocked provider tests ensure correct model selection, batching, dimension verification, and progress counter emission; failure-path tests cover missing credentials and mismatched dimensions |
| `DOC-REQ-006` (Qdrant vector store factory) | `FR-006` | `moonmind/manifest_v0/vector_store_factory.py`, `id_policy.py`, Qdrant client wrappers reused by worker; CLI/env wiring for connection refs | Tests that mock Qdrant client to assert collection creation, dimension/distance checks, delete-by-filter execution, and env/profile/vault resolution; quickstart instructions verify manual smoke |
| `DOC-REQ-007` (namespacing + metadata allowlist) | `FR-007` | Engine chunk assembly + metadata filters (likely `moonmind/manifest_v0/engine.py` + `metadata.py`), plus Qdrant payload generation | Unit tests confirm metadata filtering enforces allowlists, includes manifest/dataSource/doc identifiers, and rejects unknown fields before upsert |
| `DOC-REQ-008` (deterministic IDs + delete semantics) | `FR-008` | `moonmind/manifest_v0/id_policy.py`, delete pipeline inside `engine.py` and vector store wrapper | Tests assert `point_id` stable hashing, delete-before-upsert order, and delete-by-filter on `SourceChange(kind="delete")`; integration test ensures `forceFull` triggers full delete cycle |
| `DOC-REQ-009` (checkpoint state persistence) | `FR-009` | `moonmind/manifest_v0/state_store.py`, API callbacks in `api_service/services/manifests_service.py`, DB migrations ensuring `state_json/state_updated_at` ready | Unit tests mocking registry service verify checkpoint JSON reads/writes, timestamp updates, and worker callback flows; API router tests ensure new endpoints persist state |
| `DOC-REQ-010` (manifest worker service + preflight) | `FR-010` | `moonmind/agents/manifest_worker/{cli.py,worker.py,handlers.py}`, `poetry` console entry, container wiring | Worker unit tests cover config parsing, preflight (Qdrant ping, embeddings credential validation), lease handling, and heartbeat logic; manual quickstart & automated smoke confirm standalone daemon behavior |
| `DOC-REQ-011` (stage events + artifacts) | `FR-011` | Worker stage orchestration + queue API client; SSE schema additions in `api_service/api/routers/queue.py` / `moonmind/schemas/agent_queue_models.py`; artifact upload helper | Tests simulate a run to assert events fire in order with counts/timings and artifact uploads succeed (fixtures validate required artifact keys); SSE contract described in `contracts/manifest-phase1.openapi.yaml` |
| `DOC-REQ-012` (cancellation + secret redaction) | `FR-012` | Worker cancellation handling, shared secret resolution utilities, artifact post-processing to redact sensitive values | Tests trigger cancellation mid-run to ensure worker halts, updates run summary status, and acknowledges cancel endpoint; log/artifact scrubbers tested with synthetic secrets |
| `DOC-REQ-013` (source kinds + action/override handling) | `FR-006` | `manifest_contract.normalize_manifest_job_payload` (existing) plus manifest_v0 engine support for `inline`, `registry`, optional `path` sources; queue override validation reused during execution | Unit tests ensure `engine.plan/run` respects `dryRun`, `forceFull`, `maxDocs`, rejects structural overrides, and handles inline vs registry content by loading YAML via registry service when needed |
