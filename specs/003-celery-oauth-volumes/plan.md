# Implementation Plan: Celery OAuth Volume Mounts

**Branch**: `001-celery-oauth-volumes` | **Date**: 2025-11-05 | **Spec**: [/specs/001-celery-oauth-volumes/spec.md](spec.md)
**Input**: Feature specification from `/specs/001-celery-oauth-volumes/spec.md`

## Summary

Implement persistent Codex authentication volumes and sharded Celery routing so Spec Kit automation reuses OAuth logins, enforces pre-flight checks, and records shard/volume metadata for every Codex run while providing operator runbooks for credential stewardship.

## Technical Context

**Language/Version**: Python 3.11 (existing MoonMind services)  
**Primary Dependencies**: Celery 5.x worker stack, Docker SDK for Python, Docker Compose services  
**Storage**: Docker named volumes (`speckit_workspaces`, `codex_auth_{0,1,2}`) plus existing PostgreSQL/RabbitMQ backends  
**Testing**: pytest with integration coverage for Celery workflow, smoke validation via Spec Kit end-to-end tooling  
**Target Platform**: Containerized Linux environment orchestrated via Docker Compose  
**Project Type**: Backend automation services (Celery workers + orchestration utilities)  
**Performance Goals**: Maintain ≥95% Codex runs without manual reauthentication and route Codex tasks with negligible queue contention (target <1 additional minute per run)  
**Constraints**: Preserve credential security (0700 volume mounts, non-root user), no increase in non-Codex queue latency, must support detached HEAD operation via explicit branch targeting  
**Scale/Scope**: Three dedicated Codex worker shards at launch with path to horizontal expansion

## Constitution Check

The constitution file currently contains placeholder sections with no enforceable principles or gates; treating all gates as PASS with note that future ratified principles may introduce additional checks. Post-Phase 1 review confirms the design artifacts remain within these placeholders without introducing conflicting practices.

## Project Structure

### Documentation (this feature)

```text
specs/001-celery-oauth-volumes/
├── plan.md              # Implementation plan (this document)
├── research.md          # Phase 0 synthesis
├── data-model.md        # Phase 1 entities and lifecycle
├── quickstart.md        # Operator and developer onboarding
├── contracts/           # Phase 1 API/CLI contracts
└── tasks.md             # Generated by /speckit.tasks (Phase 2)
```

### Source Code (repository root)

```text
celery_worker/
└── speckit_worker.py        # Celery entrypoint and queue routing hooks

docker-compose.yaml          # Compose topology (new Codex workers + volumes)
docker-compose.job.yaml      # Job container definition references

moonmind/workflows/speckit_celery/
├── job_container.py         # Job container lifecycle and mounts
├── tasks.py                 # Codex phase execution helpers
└── orchestrator.py          # Submit/publish orchestration

images/worker/Dockerfile     # Celery worker base image
images/job/Dockerfile        # Spec automation job image
```

**Structure Decision**: Extend existing Celery workflow modules (`moonmind/workflows/speckit_celery/`) and deployment assets (Compose, worker/job images) because the feature modifies container lifecycle, queue routing, and operator runbooks without introducing new service boundaries.

## Complexity Tracking

No constitution violations identified; table not required.
