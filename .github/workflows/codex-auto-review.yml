name: Codex Auto Review

on:
  pull_request:
    types: [synchronize]  # Triggers when new commits are pushed to a PR

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  auto-review:
    runs-on: self-hosted

    steps:
      - name: Request Codex review on new commits
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PR_AGENT_TOKEN || github.token }}
          script: |
            const pr_number = context.payload.pull_request.number;

            console.log(`Processing PR #${pr_number}`);
            console.log(`Triggered by new commit push`);

            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            console.log(`PR: ${pr.title}`);
            console.log(`Head SHA: ${pr.head.sha}`);

            // Get commits to check if this is beyond the first commit
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number,
              per_page: 100
            });

            console.log(`Total commits: ${commits.length}`);

            if (commits.length <= 1) {
              console.log('This is the first commit. Not requesting auto-review.');
              return;
            }

            console.log('Multiple commits detected. Checking if review should be requested...');

            // Check for "eyes" reactions on the PR
            const { data: reactions } = await github.rest.reactions.listForIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number
            });

            const hasEyesReaction = reactions.some(r => r.content === 'eyes');

            if (hasEyesReaction) {
              console.log('PR has "eyes" reactions - someone is actively reviewing. Skipping auto-review.');
              return;
            }

            console.log('No "eyes" reactions found. Continuing...');

            // Get issue comments to check for recent @codex review requests
            const { data: issueComments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              per_page: 100
            });

            // Check if we've already posted "@codex review" recently
            // Note: If using PAT, the user type won't be 'Bot', so we check against specific bot usernames
            const recentCodexReviews = issueComments.filter(comment => {
              const userLogin = comment.user?.login?.toLowerCase() || '';
              const isGitHubActionsBot = comment.user?.type === 'Bot' ||
                                        userLogin.includes('[bot]') ||
                                        userLogin === 'github-actions' ||
                                        comment.user?.id === 41898282; // github-actions[bot]
              const isCodexReview = comment.body?.includes('@codex review');
              const isRecent = new Date() - new Date(comment.created_at) < 300000; // 5 minutes
              return isGitHubActionsBot && isCodexReview && isRecent;
            });

            if (recentCodexReviews.length > 0) {
              console.log('Already requested @codex review within the last 5 minutes. Skipping to avoid spam.');
              console.log(`Last review request: ${recentCodexReviews[0].created_at}`);
              return;
            }

            // Post the review request
            console.log('Posting @codex review comment...');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: '@codex review'
            });

            console.log('âœ… @codex review comment posted successfully!');

