version: "v0"
metadata:
  name: "moonmind-kitchen-sink"
  description: "Multi-source ingest with hybrid retrieval and evaluation"
  owner: "search-platform@moonladdr"
  tags: ["demo","full","example"]

llm:
  provider: "openai"
  model: "gpt-4o-mini"
  temperature: 0.0

embeddings:
  provider: "openai"
  model: "text-embedding-3-large"
  batchSize: 256

vectorStore:
  type: "qdrant"
  indexName: "mm_full_v0"
  connection:
    host: "${QDRANT_HOST}"
    port: ${QDRANT_PORT}

dataSources:
  - id: "github-code-docs"
    type: "GithubRepositoryReader"
    params:
      owner: "MoonLadderStudios"
      repo: "MoonMind"
      branch: "main"
      include: ["**/*.py","**/*.md"]
      exclude: ["tests/**","**/__pycache__/**","**/*.png","**/*.jpg"]
      maxFiles: 5000
    auth:
      githubToken: "${GITHUB_TOKEN}"
    schedule: "0 4 * * *"   # nightly cron (optional)

  - id: "gdrive-specs"
    type: "GoogleDriveReader"
    params:
      folderId: "${SPECS_FOLDER_ID}"
      mimeTypes: ["application/pdf","application/vnd.google-apps.document"]

  - id: "local-handbook"
    type: "SimpleDirectoryReader"
    params:
      inputDir: "./handbook"
      recursive: true
      requiredExts: [".md",".txt"]

transforms:
  htmlToText: true
  splitter:
    type: "TokenTextSplitter"
    chunkSize: 800
    chunkOverlap: 120
  enrichMetadata:
    - type: "PathToTags"
    - type: "InferDocType"   # code|design|spec|handbook

indices:
  - id: "mm_full_vector"
    type: "VectorStoreIndex"
    sources: ["github-code-docs","gdrive-specs","local-handbook"]
    persist:
      path: "s3://moonmind-indices/mm_full_vector_v0/"

retrievers:
  - id: "mm_hybrid"
    type: "Hybrid"           # vector + BM25
    indices: ["mm_full_vector"]
    params:
      topK: 10
      alpha: 0.55            # vector weight
    reranker:
      type: "bge-reranker-large"
      topK: 5

postprocessors:
  - type: "SimilarityCutoff"
    threshold: 0.74
  - type: "PrevNextNodeFetcher"
    window: 1

evaluation:
  datasets:
    - name: "smoke"
      path: "./examples/eval/smoke.jsonl"
  metrics:
    - name: "hitRate@10"
      threshold: 0.80
    - name: "ndcg@10"
      threshold: 0.70
    - name: "faithfulness"
      threshold: 0.85

run:
  concurrency: 12
  batchSize: 512
  errorPolicy: "continue"
  dryRun: false

observability:
  tracing: "opentelemetry"
  logs: "stdout"
  callbacks: "llamaindex"

security:
  piiRedaction: true
  allowlistMetadata: ["path","repo","branch","owner","docType"]

scheduling: "manual"
