x-celery-worker-base: &celery-worker-base
  build:
    context: .
    dockerfile: ./api_service/Dockerfile
  image: ghcr.io/moonladderstudios/moonmind:latest
  environment: &celery-environment
    PYTHONPATH: /app
    LOG_LEVEL: ${LOG_LEVEL:-INFO}
    PYTHONUNBUFFERED: "1"
    MOONMIND_QUEUE: ${MOONMIND_QUEUE:-moonmind.jobs}
    MOONMIND_WORKER_RUNTIME: ${MOONMIND_WORKER_RUNTIME:-codex}
    CODEX_VOLUME_NAME: ${CODEX_VOLUME_NAME:-codex_auth_volume}
    CODEX_VOLUME_PATH: ${CODEX_VOLUME_PATH:-/home/app/.codex}
    CODEX_HOME: ${CODEX_HOME:-/home/app/.codex}
    CODEX_CONFIG_HOME: ${CODEX_CONFIG_HOME:-/home/app/.codex}
    CODEX_CONFIG_PATH: ${CODEX_CONFIG_PATH:-/home/app/.codex/config.toml}
    CLAUDE_VOLUME_NAME: ${CLAUDE_VOLUME_NAME:-claude_auth_volume}
    CLAUDE_VOLUME_PATH: ${CLAUDE_VOLUME_PATH:-/home/app/.claude}
    CLAUDE_HOME: ${CLAUDE_HOME:-/home/app/.claude}
    CELERY_BROKER_URL: amqp://${RABBITMQ_USER?Variable RABBITMQ_USER is not set}:${RABBITMQ_PASSWORD?Variable RABBITMQ_PASSWORD is not set}@rabbitmq:5672//
    CODEX_TEMPLATE_PATH: /app/api_service/config.template.toml
    GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
    GEMINI_API_KEY: ${GEMINI_API_KEY:-}
  env_file:
    - .env
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - ./moonmind:/app/moonmind:ro
    - ./api_service:/app/api_service:ro
    - ./celery_worker:/app/celery_worker:ro
    - ./specs:/app/specs:ro
    - ./model_data:/app/model_data
    - ./var/artifacts/spec_workflows:/app/var/artifacts/spec_workflows
    - codex_auth_volume:${CODEX_VOLUME_PATH:-/home/app/.codex}
    - claude_auth_volume:${CLAUDE_HOME:-/home/app/.claude}
    - speckit_workspaces:/work/runs
  depends_on:
    rabbitmq:
      condition: service_started
    api-db:
      condition: service_started
  networks:
    - local-network
  restart: unless-stopped

services:
  keycloak-db:
    profiles: ["keycloak"]
    image: postgres:${POSTGRES_VERSION:-17}
    environment:
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KC_DB_PW:-keycloak}
      POSTGRES_DB: keycloak
    volumes: [ keycloak-data:/var/lib/postgresql/data ]
    networks: [ local-network ]
    restart: unless-stopped

  keycloak:
    profiles: ["keycloak"]
    image: quay.io/keycloak/keycloak:24.0
    command: >
      start-dev
      --proxy-headers=xforwarded
      --hostname-url=http://keycloak:8080
      --import-realm
      --db=postgres
      --db-url=jdbc:postgresql://keycloak-db:5432/keycloak
      --db-username=keycloak
      --db-password=${KC_DB_PW:-keycloak}
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: ${KC_ADMIN_PW:-admin}
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    ports: [ "8085:8080" ]        # hostâ†’container
    depends_on:
      - keycloak-db
    networks: [ local-network ]
    restart: unless-stopped

  ui:
    image: ghcr.io/open-webui/open-webui:main
    volumes:
      - open-webui:/app/backend/data
    ports:
      - 8080:8080
    environment:
      - OPENAI_API_BASE_URL=${OPENAI_API_BASE_URL:-http://api:5000/v1}
      - WEBUI_AUTH=${WEBUI_AUTH:-false}
      # - WEBUI_FORWARD_AUTH_HEADER=${WEBUI_FORWARD_AUTH_HEADER:-true} # Keep or remove based on final setup with OIDC
      - ENABLE_OLLAMA_API=false
      # OIDC specific variables for OpenWebUI
      - ENABLE_OAUTH_SIGNUP=${WEBUI_AUTH:-false}
      - OAUTH_PROVIDER_NAME=Keycloak # Can be changed by .env if needed
      - OAUTH_CLIENT_ID=open-webui # As defined in realm-export.json
      - OAUTH_CLIENT_SECRET= # Left blank for PKCE
      - OAUTH_SCOPES=openid email profile
      - OPENID_PROVIDER_URL=http://keycloak:8080/realms/moonmind/.well-known/openid-configuration # Internal URL for Keycloak
      - WEBUI_FORWARD_AUTH_HEADER=${WEBUI_AUTH:-false} # Important for API to get the token
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - local-network
    depends_on:
      - api

  api:
    build:
      context: .
      dockerfile: ./api_service/Dockerfile
    image: ghcr.io/moonladderstudios/moonmind:latest
    ports:
      - "5000:5000"
    environment:
      - PYTHONPATH=/app
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}
      - PYTHONUNBUFFERED=1
      - CELERY_BROKER_URL=amqp://${RABBITMQ_USER?Variable RABBITMQ_USER is not set}:${RABBITMQ_PASSWORD?Variable RABBITMQ_PASSWORD is not set}@rabbitmq:5672//
      - CODEX_TEMPLATE_PATH=/app/api_service/config.template.toml
      - FASTAPI_RELOAD=${FASTAPI_RELOAD:-false}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - MODEL_CONTEXT_PROTOCOL_ENABLED=true
      - MODEL_CONTEXT_PROTOCOL_PORT=5000
      - MODEL_CONTEXT_PROTOCOL_HOST=0.0.0.0
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      # OIDC specific variables for API service
      - AUTH_PROVIDER=${AUTH_PROVIDER:-disabled} # local, google, or disabled
      - OIDC_ISSUER_URL=${OIDC_ISSUER_URL:-http://keycloak:8080/realms/moonmind} # For 'local'
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-api-service} # For 'local', matches realm-export.json
      - OIDC_CLIENT_SECRET=${API_CLIENT_SECRET:-changeme} # For 'local', matches realm-export.json
      - JWT_SECRET=${JWT_SECRET:-devsecret} # For 'disabled' auth provider (legacy JWT)
    env_file:
      - .env
    volumes:
      - ./model_data:/app/model_data
      - ./api_service:/app/api_service
      - ./moonmind:/app/moonmind:ro
      - ./.agents:/app/.agents:ro
      - ./keycloak:/app/keycloak:ro # Mount keycloak configs if needed by api, or remove if only for keycloak service
      - speckit_workspaces:/work/runs:ro
    command: sh /app/api_service/entrypoint.sh
    networks:
      - local-network
    labels:
      - "ai.model.context.protocol.version=0.1"
      - "ai.model.context.protocol.endpoint=/context"
    depends_on:
      init-db:
        condition: service_completed_successfully
      api-db:
        condition: service_started
      rabbitmq:
        condition: service_started

  api-db:
    image: postgres:${POSTGRES_VERSION:-17}
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-moonmind}
    volumes:
      - api-db-data:/var/lib/postgresql/data
    expose:
      - "5432"
    networks:
      - local-network
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:v1.14.1
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-storage:/qdrant/storage
    networks:
      - local-network

  init-db:
    build:
      context: .
      dockerfile: ./api_service/Dockerfile
    image: ghcr.io/moonladderstudios/moonmind:latest
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@api-db:5432/${POSTGRES_DB:-moonmind}
      - PYTHONPATH=/app
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
    env_file:
      - .env
    volumes:
      - ./moonmind:/app/moonmind:ro
      - ./tools:/app/tools:ro
      - ./model_data:/app/model_data:ro
      - ./api_service:/app/api_service:ro
      - ./init_db:/app/init_db
    command: sh /app/init_db/init_db_entrypoint.sh
    networks:
      - local-network
    restart: "no"
    depends_on:
      - api-db
      - qdrant

  rabbitmq:
    image: rabbitmq:3.13-management
    hostname: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER?Variable RABBITMQ_USER is not set}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD?Variable RABBITMQ_PASSWORD is not set}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - local-network
    restart: unless-stopped

  celery-worker:
    <<: *celery-worker-base
    command: >-
      celery -A celery_worker.speckit_worker worker
      --loglevel=${CELERY_LOG_LEVEL:-info}
      --queues=${MOONMIND_QUEUE:-moonmind.jobs}

  celery_codex_worker:
    <<: *celery-worker-base
    environment:
      <<: *celery-environment
      MOONMIND_WORKER_RUNTIME: codex
    command: >-
      celery -A celery_worker.speckit_worker worker
      --loglevel=${CELERY_LOG_LEVEL:-info}
      --queues=${MOONMIND_QUEUE:-moonmind.jobs}

  celery_gemini_worker:
    <<: *celery-worker-base
    environment:
      <<: *celery-environment
      MOONMIND_WORKER_RUNTIME: gemini
      GEMINI_HOME: ${GEMINI_HOME:-/var/lib/gemini-auth}
    command: >-
      celery -A celery_worker.gemini_worker worker
      --loglevel=${CELERY_LOG_LEVEL:-info}
      --queues=${MOONMIND_QUEUE:-moonmind.jobs}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./moonmind:/app/moonmind:ro
      - ./api_service:/app/api_service:ro
      - ./celery_worker:/app/celery_worker:ro
      - ./specs:/app/specs:ro
      - ./model_data:/app/model_data
      - ./var/artifacts/spec_workflows:/app/var/artifacts/spec_workflows
      - codex_auth_volume:${CODEX_VOLUME_PATH:-/home/app/.codex}
      - speckit_workspaces:/work/runs
      - gemini_auth_volume:${GEMINI_HOME:-/var/lib/gemini-auth}

  celery_claude_worker:
    <<: *celery-worker-base
    environment:
      <<: *celery-environment
      MOONMIND_WORKER_RUNTIME: claude
    command: >-
      celery -A celery_worker.speckit_worker worker
      --loglevel=${CELERY_LOG_LEVEL:-info}
      --queues=${MOONMIND_QUEUE:-moonmind.jobs}

  codex-worker:
    build:
      context: .
      dockerfile: ./api_service/Dockerfile
    image: ghcr.io/moonladderstudios/moonmind:latest
    user: app
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=1
      - CODEX_VOLUME_PATH=${CODEX_VOLUME_PATH:-/home/app/.codex}
      - CODEX_HOME=${CODEX_HOME:-/home/app/.codex}
      - CODEX_CONFIG_HOME=${CODEX_CONFIG_HOME:-/home/app/.codex}
      - CODEX_CONFIG_PATH=${CODEX_CONFIG_PATH:-/home/app/.codex/config.toml}
      - CLAUDE_VOLUME_PATH=${CLAUDE_VOLUME_PATH:-/home/app/.claude}
      - CLAUDE_HOME=${CLAUDE_HOME:-/home/app/.claude}
      - MOONMIND_URL=${MOONMIND_URL:-http://api:5000}
      - MOONMIND_WORKER_ID=${MOONMIND_WORKER_ID:-codex-worker-1}
      - MOONMIND_ENABLE_TASK_PROPOSALS=${MOONMIND_ENABLE_TASK_PROPOSALS:-true}
      - MOONMIND_WORKER_TOKEN=${MOONMIND_WORKER_TOKEN:-}
      - MOONMIND_WORKER_BOOTSTRAP_TOKEN=${MOONMIND_WORKER_BOOTSTRAP_TOKEN:-true}
      - MOONMIND_WORKER_ALLOWED_TYPES=${MOONMIND_WORKER_ALLOWED_TYPES:-task,codex_exec,codex_skill}
      - MOONMIND_WORKER_CAPABILITIES=${MOONMIND_WORKER_CAPABILITIES:-codex,git,gh,docker,proposals_write}
      - MOONMIND_WORKER_TOKEN_DESCRIPTION=${MOONMIND_WORKER_TOKEN_DESCRIPTION:-Docker Compose codex worker}
      - MOONMIND_API_TOKEN=${MOONMIND_API_TOKEN:-}
      - MOONMIND_WORKDIR=${MOONMIND_WORKDIR:-/work/agent_jobs}
      - MOONMIND_WORKER_SPEC_WORKFLOW_REPO_ROOT=${MOONMIND_WORKER_SPEC_WORKFLOW_REPO_ROOT:-/workspace}
      - SPEC_SKILLS_LOCAL_MIRROR_ROOT=${MOONMIND_WORKER_SPEC_SKILLS_LOCAL_MIRROR_ROOT:-/workspace/.agents/skills/local}
      - SPEC_SKILLS_LEGACY_MIRROR_ROOT=${MOONMIND_WORKER_SPEC_SKILLS_LEGACY_MIRROR_ROOT:-/workspace/.agents/skills}
      - MOONMIND_LIVE_SESSION_ENABLED_DEFAULT=${MOONMIND_LIVE_SESSION_ENABLED_DEFAULT:-true}
      - MOONMIND_LIVE_SESSION_PROVIDER=${MOONMIND_LIVE_SESSION_PROVIDER:-tmate}
      - MOONMIND_LIVE_SESSION_TTL_MINUTES=${MOONMIND_LIVE_SESSION_TTL_MINUTES:-60}
      - MOONMIND_LIVE_SESSION_RW_GRANT_TTL_MINUTES=${MOONMIND_LIVE_SESSION_RW_GRANT_TTL_MINUTES:-15}
      - MOONMIND_LIVE_SESSION_ALLOW_WEB=${MOONMIND_LIVE_SESSION_ALLOW_WEB:-false}
      - MOONMIND_TMATE_SERVER_HOST=${MOONMIND_TMATE_SERVER_HOST:-}
      - MOONMIND_LIVE_SESSION_MAX_CONCURRENT_PER_WORKER=${MOONMIND_LIVE_SESSION_MAX_CONCURRENT_PER_WORKER:-4}
      - MOONMIND_CONTAINER_WORKSPACE_VOLUME=${MOONMIND_AGENT_WORKSPACES_VOLUME_NAME:-agent_workspaces}
      - DOCKER_HOST=${ORCHESTRATOR_DOCKER_HOST:-tcp://docker-proxy:2375}
      - MOONMIND_CODEX_MODEL=${MOONMIND_CODEX_MODEL:-}
      - MOONMIND_CODEX_EFFORT=${MOONMIND_CODEX_EFFORT:-}
      - MOONMIND_WORKER_RETRY_ENABLED=${MOONMIND_WORKER_RETRY_ENABLED:-true}
      - MOONMIND_WORKER_RETRY_SECONDS=${MOONMIND_WORKER_RETRY_SECONDS:-20}
      - MOONMIND_DEFAULT_TASK_RUNTIME=${MOONMIND_DEFAULT_TASK_RUNTIME:-codex}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - DEFAULT_EMBEDDING_PROVIDER=${MOONMIND_WORKER_EMBEDDING_PROVIDER_OVERRIDE:-disabled}
    volumes:
      - .:/workspace
      - codex_auth_volume:${CODEX_VOLUME_PATH:-/home/app/.codex}
      - claude_auth_volume:${CLAUDE_HOME:-/home/app/.claude}
      - speckit_workspaces:/work/runs
      - ./var/artifacts:/workspace/var/artifacts
      - agent_workspaces:/work/agent_jobs
    working_dir: /workspace
    command: >-
      /workspace/tools/start-codex-worker.sh
    depends_on:
      api:
        condition: service_started
      docker-proxy:
        condition: service_started
    networks:
      - local-network
    restart: unless-stopped

  orchestrator:
    build:
      context: .
      dockerfile: ./api_service/Dockerfile
    image: ghcr.io/moonladderstudios/moonmind:latest
    command: >-
      /workspace/services/orchestrator/entrypoint.sh
    env_file:
      - .env
    environment:
      - CELERY_BROKER_URL=${SPEC_WORKFLOW_CELERY_BROKER_URL:-amqp://${RABBITMQ_USER:-moonmind}:${RABBITMQ_PASSWORD:-password}@rabbitmq:5672//}
      - CELERY_RESULT_BACKEND=${SPEC_WORKFLOW_CELERY_RESULT_BACKEND:-db+postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@api-db:5432/${POSTGRES_DB:-moonmind}}
      - ORCHESTRATOR_CELERY_QUEUE=${ORCHESTRATOR_CELERY_QUEUE:-orchestrator.run}
      - ORCHESTRATOR_ARTIFACT_ROOT=${ORCHESTRATOR_ARTIFACT_ROOT:-var/artifacts/spec_workflows}
      - ORCHESTRATOR_STATSD_HOST=${ORCHESTRATOR_STATSD_HOST:-}
      - ORCHESTRATOR_STATSD_PORT=${ORCHESTRATOR_STATSD_PORT:-8125}
      - DOCKER_HOST=${ORCHESTRATOR_DOCKER_HOST:-tcp://docker-proxy:2375}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
    volumes:
      - .:/workspace
    working_dir: /workspace
    depends_on:
      rabbitmq:
        condition: service_started
      api:
        condition: service_started
      docker-proxy:
        condition: service_started
    networks:
      - local-network
    restart: unless-stopped

  docker-proxy:
    image: tecnativa/docker-socket-proxy:0.1.1
    environment:
      CONTAINERS: 1
      IMAGES: 1
      NETWORKS: 1
      VOLUMES: 1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - local-network
    restart: unless-stopped

  ollama:
    profiles: ["ollama"]
    image: ollama/ollama:latest
    ports:
      - 11434:11434
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      - ./model_data:/root/.ollama/models
      - ./tools/entrypoint-ollama.sh:/entrypoint-ollama.sh:ro
    entrypoint: ["/bin/sh", "/entrypoint-ollama.sh"]
    networks:
      - local-network
    env_file:
      - .env
    environment:
      - OLLAMA_CONTEXT_LENGTH=32768
      - OLLAMA_FLASH_ATTENTION=true
      - OLLAMA_KV_CACHE_TYPE=q4_0

  openhands:
    profiles: ["openhands"]
    image: docker.all-hands.dev/all-hands-ai/openhands:0.39
    container_name: openhands-app
    pull_policy: always
    tty: true
    stdin_open: true
    ports:
      - "3000:3000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./.openhands-state-data:/.openhands-state
      - ./config.toml:/app/openhands/config.toml:ro
      - .:/workspace
    environment:
      - SANDBOX_RUNTIME_CONTAINER_IMAGE=docker.all-hands.dev/all-hands-ai/runtime:0.39-nikolaik
      - LOG_ALL_EVENTS=true
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - local-network
    env_file:
      - .env

  vllm:
    profiles: ["vllm"]
    image: vllm/vllm-openai:latest
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      - ./model_data:/root/.cache/huggingface/hub
      - ./tools/entrypoint-vllm.sh:/entrypoint-vllm.sh:ro
    ports:
      - "8000:8000"
    environment:
      - MODEL_NAME=${VLLM_MODEL_NAME:-ByteDance-Seed/UI-TARS-1.5-7B}
      - DTYPE=${VLLM_DTYPE:-float16}
      - GPU_MEMORY_UTILIZATION=${VLLM_GPU_MEMORY_UTILIZATION:-0.95}
      - HF_HOME=/root/.cache/huggingface
      - MAX_MODEL_LEN=${VLLM_MAX_MODEL_LEN:-32768}
      - NVIDIA_DRIVER_CAPABILITIES=all
    entrypoint: ["/bin/sh", "/entrypoint-vllm.sh"]
    networks:
      - local-network
    tty: true
    init: true

volumes:
  open-webui:
  qdrant-storage:
  api-db-data:
  keycloak-data:
  rabbitmq-data:
  speckit_workspaces:
  agent_workspaces:
    name: ${MOONMIND_AGENT_WORKSPACES_VOLUME_NAME:-agent_workspaces}
  unreal_ccache_volume:
    name: unreal_ccache_volume
  unreal_ubt_volume:
    name: unreal_ubt_volume
  codex_auth_volume:
    name: ${CODEX_VOLUME_NAME:-codex_auth_volume}
  claude_auth_volume:
    name: ${CLAUDE_VOLUME_NAME:-claude_auth_volume}
  gemini_auth_volume:

networks:
  local-network:
    external: true
